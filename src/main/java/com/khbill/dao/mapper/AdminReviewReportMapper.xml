<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.khbill.dao.face.AdminReviewReportDao">

	<sql id="selectReviewReport">
		SELECT 
            X.report_no, X.report_category, X.report_content, X.respondent_no
            , R.review_no, U.user_no, U.user_nick, R.review_title, X.report_date, X.report_status
        FROM zreview R
        INNER JOIN zuser U 
        	ON U.user_no = R.user_no
        INNER JOIN zreview_report X 
        	ON X.review_no = R.review_no
	</sql>
	
	<sql id="whereReviewReportTitleSearch">
		WHERE review_title LIKE '%' || #{search} || '%'
	</sql>

	<select id="selectReviewReportList" parameterType="com.khbill.util.Paging" resultType="HashMap">
		SELECT * FROM (
			SELECT rownum rnum, R.* FROM (
		    	<include refid="selectReviewReport"/>   
		    	<include refid="whereReviewReportTitleSearch"/>   
		        ORDER BY report_no DESC
		   ) R
		) ZREVIEW
		WHERE rnum BETWEEN #{startNo } AND #{endNo }
	</select>

	<select id="selectCntAll" resultType="int" parameterType="com.khbill.util.Paging">
		SELECT count(*) FROM (
			<include refid="selectReviewReport"/>
			<include refid="whereReviewReportTitleSearch"/>
		)
	</select>
	
	<update id="updateReviewReportByStatusY" parameterType="com.khbill.dto.ReviewReport">
		UPDATE zreview_report
		SET report_status = 'y'
		WHERE review_no = #{reviewNo }
	</update>
	
	<select id="selectCntReviewReportByStatusY" parameterType="com.khbill.dto.ReviewReport" resultType="int">
		SELECT count(*) FROM zreview_report
		WHERE review_no = #{reviewNo } AND report_status = 'y'
	</select>
	
	<update id="updateReviewReportByStatusN" parameterType="com.khbill.dto.ReviewReport">
		UPDATE zreview_report
		SET report_status = 'n'
		WHERE review_no = #{reviewNo }
	</update>
	
	<select id="selectCntReviewReportByStatusN" parameterType="com.khbill.dto.ReviewReport" resultType="int">
		SELECT count(*) FROM zreview_report
		WHERE review_no = #{reviewNo } AND report_status = 'n'
	</select>	

	<update id="updatehit" parameterType="com.khbill.dto.Review">
		UPDATE ZREVIEW
		SET review_hit = review_hit + 1
		WHERE review_no = #{reviewNo }
	</update>
	
	<select id="selectReviewByReviewNo" parameterType="com.khbill.dto.ReviewReport" resultType="HashMap">
		SELECT * FROM (
	        SELECT DISTINCT
	            X.report_no, X.review_no, X.report_category, X.report_content, X.respondent_no
      		   , I.item_no, I.item_brand, I.item_price, R.file_no, F.file_stored
     		   , U.user_no, U.user_nick, R.review_title, X.report_date, X.report_status
	        FROM zreview_report X
	        INNER JOIN zuser U    ON U.user_no = x.respondent_no
	        INNER JOIN zreview R  ON X.review_no = R.review_no
	        INNER JOIN zitem I    ON I.item_no = R.item_no
	        INNER JOIN zfile F    ON F.file_no = R.file_no
		) ZREVIEW_REPORT
		WHERE report_no = #{reportNo }
	</select>
	 
	<select id="selectItemByItemNo" resultType="com.khbill.dto.Item" parameterType="int">
		SELECT * FROM zitem
		WHERE item_no = #{itemNo }
	</select>

	<select id="selectFileByFile" resultType="com.khbill.dto.File" parameterType="int">
		SELECT
			file_no, file_origin, file_stored, file_size, file_date
		FROM zfile
		WHERE file_no = #{fileNo }
	</select>
	
	<select id="selectReviewCommentByReview" parameterType="com.khbill.dto.ReviewComment" resultType="HashMap">
		SELECT * FROM (
		    SELECT rownum rnum, C.* FROM (
		        SELECT DISTINCT
		             review_com_no, U.user_no, user_nick, C.review_no
		            , review_com_content, review_com_date, review_com_like, review_com_hate, W.grade_url
		        FROM ZREVIEW_COMMENT C
		        LEFT OUTER JOIN zuser U  ON U.user_no = C.user_no
		        LEFT OUTER JOIN USERWITHURL W ON U.user_no = W.user_no
		        LEFT OUTER JOIN zreview R ON C.review_no = C.review_no
		        --LEFT OUTER JOIN zreview_report X ON X.review_no = C.review_no
		        WHERE C.review_no = #{reviewNo }
		        ORDER BY review_com_no
		     ) C
		) ZREVIEW_COMMENT
	</select>
	
</mapper>